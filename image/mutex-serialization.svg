<svg viewBox="0 0 820 680" xmlns="http://www.w3.org/2000/svg" font-family="'Courier New', monospace">
  <defs>
    <marker id="arr" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0,10 3.5,0 7" fill="#334155"/>
    </marker>
    <marker id="arr-grn" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0,10 3.5,0 7" fill="#16a34a"/>
    </marker>
    <marker id="arr-seq" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0,10 3.5,0 7" fill="#0369a1"/>
    </marker>
    <filter id="sh">
      <feDropShadow dx="1" dy="2" stdDeviation="3" flood-color="#00000020"/>
    </filter>
    <filter id="sh2">
      <feDropShadow dx="0" dy="1" stdDeviation="2" flood-color="#00000015"/>
    </filter>
    <linearGradient id="csGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#fef3c7"/>
      <stop offset="100%" stop-color="#fffbeb"/>
    </linearGradient>
    <linearGradient id="mutexGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#fde68a"/>
      <stop offset="100%" stop-color="#fbbf24"/>
    </linearGradient>
    <linearGradient id="qGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#e0f2fe"/>
      <stop offset="100%" stop-color="#bae6fd"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="820" height="680" fill="#f8fafc"/>

  <!-- Title -->
  <text x="410" y="28" text-anchor="middle" font-size="14" font-weight="bold" fill="#0f172a" letter-spacing="0.5">«concurrency» Mutex Serialization — Booking Request Queue</text>

  <!-- ══ SECTION 1: REQUEST QUEUE ══ -->
  <rect x="30" y="42" width="760" height="126" rx="6" fill="#f0f9ff" stroke="#7dd3fc" stroke-width="1.5"/>
  <rect x="30" y="42" width="130" height="18" rx="3" fill="#0ea5e9"/>
  <text x="95" y="55" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">«queue»  Incoming</text>

  <!-- Request boxes: 5 × 106px with 13px gap, starting x=55 -->
  <!-- Req 1 -->
  <rect x="55"  y="64" width="106" height="72" rx="5" fill="url(#qGrad)" stroke="#38bdf8" stroke-width="1.8" filter="url(#sh2)"/>
  <rect x="55"  y="64" width="106" height="18" rx="5" fill="#0284c7"/>
  <rect x="55"  y="74" width="106" height="8" fill="#0284c7"/>
  <text x="108" y="77" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">Request 1</text>
  <text x="108" y="96" text-anchor="middle" font-size="9" fill="#0c4a6e">POST /bookings</text>
  <text x="108" y="109" text-anchor="middle" font-size="9" fill="#0c4a6e">event_id: 42</text>
  <text x="108" y="122" text-anchor="middle" font-size="9" fill="#0c4a6e">qty: 2</text>

  <!-- Req 2 -->
  <rect x="174" y="64" width="106" height="72" rx="5" fill="url(#qGrad)" stroke="#38bdf8" stroke-width="1.8" filter="url(#sh2)"/>
  <rect x="174" y="64" width="106" height="18" rx="5" fill="#0284c7"/>
  <rect x="174" y="74" width="106" height="8" fill="#0284c7"/>
  <text x="227" y="77" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">Request 2</text>
  <text x="227" y="96" text-anchor="middle" font-size="9" fill="#0c4a6e">POST /bookings</text>
  <text x="227" y="109" text-anchor="middle" font-size="9" fill="#0c4a6e">event_id: 42</text>
  <text x="227" y="122" text-anchor="middle" font-size="9" fill="#0c4a6e">qty: 1</text>

  <!-- Req 3 -->
  <rect x="293" y="64" width="106" height="72" rx="5" fill="url(#qGrad)" stroke="#38bdf8" stroke-width="1.8" filter="url(#sh2)"/>
  <rect x="293" y="64" width="106" height="18" rx="5" fill="#0284c7"/>
  <rect x="293" y="74" width="106" height="8" fill="#0284c7"/>
  <text x="346" y="77" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">Request 3</text>
  <text x="346" y="96" text-anchor="middle" font-size="9" fill="#0c4a6e">POST /bookings</text>
  <text x="346" y="109" text-anchor="middle" font-size="9" fill="#0c4a6e">event_id: 42</text>
  <text x="346" y="122" text-anchor="middle" font-size="9" fill="#0c4a6e">qty: 3</text>

  <!-- Req 4 -->
  <rect x="412" y="64" width="106" height="72" rx="5" fill="url(#qGrad)" stroke="#38bdf8" stroke-width="1.8" filter="url(#sh2)"/>
  <rect x="412" y="64" width="106" height="18" rx="5" fill="#0284c7"/>
  <rect x="412" y="74" width="106" height="8" fill="#0284c7"/>
  <text x="465" y="77" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">Request 4</text>
  <text x="465" y="96" text-anchor="middle" font-size="9" fill="#0c4a6e">POST /bookings</text>
  <text x="465" y="109" text-anchor="middle" font-size="9" fill="#0c4a6e">event_id: 42</text>
  <text x="465" y="122" text-anchor="middle" font-size="9" fill="#0c4a6e">qty: 1</text>

  <!-- Req 5 -->
  <rect x="531" y="64" width="106" height="72" rx="5" fill="url(#qGrad)" stroke="#38bdf8" stroke-width="1.8" filter="url(#sh2)"/>
  <rect x="531" y="64" width="106" height="18" rx="5" fill="#0284c7"/>
  <rect x="531" y="74" width="106" height="8" fill="#0284c7"/>
  <text x="584" y="77" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">Request 5</text>
  <text x="584" y="96" text-anchor="middle" font-size="9" fill="#0c4a6e">POST /bookings</text>
  <text x="584" y="109" text-anchor="middle" font-size="9" fill="#0c4a6e">event_id: 42</text>
  <text x="584" y="122" text-anchor="middle" font-size="9" fill="#0c4a6e">qty: 2</text>

  <!-- Converging lines to center -->
  <line x1="108" y1="136" x2="108" y2="155" stroke="#0369a1" stroke-width="1.3"/>
  <line x1="227" y1="136" x2="227" y2="155" stroke="#0369a1" stroke-width="1.3"/>
  <line x1="346" y1="136" x2="346" y2="160" stroke="#0369a1" stroke-width="1.3"/>
  <line x1="465" y1="136" x2="465" y2="155" stroke="#0369a1" stroke-width="1.3"/>
  <line x1="584" y1="136" x2="584" y2="155" stroke="#0369a1" stroke-width="1.3"/>
  <line x1="108" y1="155" x2="584" y2="155" stroke="#0369a1" stroke-width="1.3"/>
  <line x1="346" y1="155" x2="346" y2="186" stroke="#0369a1" stroke-width="1.8" marker-end="url(#arr)"/>

  <!-- ══ MUTEX BOX ══ -->
  <rect x="230" y="186" width="232" height="60" rx="6" fill="url(#mutexGrad)" stroke="#d97706" stroke-width="2" filter="url(#sh)"/>
  <text x="346" y="206" text-anchor="middle" font-size="11" font-weight="bold" fill="#0f172a">bookingMutex</text>
  <text x="346" y="222" text-anchor="middle" font-size="10" font-style="italic" fill="#78350f">sync.Mutex</text>
  <text x="346" y="238" text-anchor="middle" font-size="9" fill="#92400e">— only ONE goroutine proceeds —</text>

  <!-- arrow mutex → critical section -->
  <line x1="346" y1="246" x2="346" y2="276" stroke="#d97706" stroke-width="1.8" marker-end="url(#arr)"/>
  <rect x="268" y="252" width="156" height="18" rx="3" fill="#fff7ed" stroke="#fcd34d" stroke-width="1"/>
  <text x="346" y="264" text-anchor="middle" font-size="9" font-weight="bold" fill="#b45309">Only ONE at a time</text>

  <!-- ══ CRITICAL SECTION ══
       Steps are 28px tall each, 8 steps = 224px content + 28px header = 252px total
       Box height = 252, y=276 → bottom at y=528
  -->
  <rect x="175" y="276" width="342" height="254" rx="6" fill="url(#csGrad)" stroke="#f59e0b" stroke-width="2.5" filter="url(#sh)"/>
  <!-- header -->
  <rect x="175" y="276" width="342" height="26" rx="6" fill="#d97706"/>
  <rect x="175" y="290" width="342" height="12" fill="#d97706"/>
  <text x="346" y="294" text-anchor="middle" font-size="11" font-weight="bold" fill="#fff" letter-spacing="1">«critical section»  createBooking()</text>

  <!-- Step rows: y starts at 308, each row h=28, gap=2 -->

  <!-- Step 1: Lock -->
  <rect x="193" y="308" width="306" height="24" rx="3" fill="#fef3c7" stroke="#fbbf24" stroke-width="1"/>
  <rect x="193" y="308" width="24"  height="24" rx="3" fill="#f59e0b"/>
  <text x="205" y="325" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">1</text>
  <text x="346" y="325" text-anchor="middle" font-size="10" fill="#0f172a">bookingMutex<tspan font-weight="bold">.Lock()</tspan></text>

  <!-- Step 2: Begin TX -->
  <rect x="193" y="336" width="306" height="24" rx="3" fill="#ede9fe" stroke="#a78bfa" stroke-width="1"/>
  <rect x="193" y="336" width="24"  height="24" rx="3" fill="#7c3aed"/>
  <text x="205" y="353" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">2</text>
  <text x="346" y="353" text-anchor="middle" font-size="10" fill="#0f172a">db<tspan font-weight="bold">.Begin()</tspan>  →  tx</text>

  <!-- Step 3: SELECT — split label to fit -->
  <rect x="193" y="364" width="306" height="24" rx="3" fill="#dcfce7" stroke="#86efac" stroke-width="1"/>
  <rect x="193" y="364" width="24"  height="24" rx="3" fill="#16a34a"/>
  <text x="205" y="381" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">3</text>
  <text x="346" y="381" text-anchor="middle" font-size="10" fill="#0f172a">tx<tspan font-weight="bold">.QueryRow</tspan>  SELECT available</text>

  <!-- Step 4: Validate -->
  <rect x="193" y="392" width="306" height="24" rx="3" fill="#dcfce7" stroke="#86efac" stroke-width="1"/>
  <rect x="193" y="392" width="24"  height="24" rx="3" fill="#16a34a"/>
  <text x="205" y="409" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">4</text>
  <text x="346" y="409" text-anchor="middle" font-size="10" fill="#0f172a">if available &lt; qty  →  <tspan font-weight="bold">Rollback</tspan></text>

  <!-- Step 5: Update -->
  <rect x="193" y="420" width="306" height="24" rx="3" fill="#dcfce7" stroke="#86efac" stroke-width="1"/>
  <rect x="193" y="420" width="24"  height="24" rx="3" fill="#16a34a"/>
  <text x="205" y="437" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">5</text>
  <text x="346" y="437" text-anchor="middle" font-size="10" fill="#0f172a">tx<tspan font-weight="bold">.Exec</tspan>  UPDATE available = n−qty</text>

  <!-- Step 6: Insert -->
  <rect x="193" y="448" width="306" height="24" rx="3" fill="#dcfce7" stroke="#86efac" stroke-width="1"/>
  <rect x="193" y="448" width="24"  height="24" rx="3" fill="#16a34a"/>
  <text x="205" y="465" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">6</text>
  <text x="346" y="465" text-anchor="middle" font-size="10" fill="#0f172a">tx<tspan font-weight="bold">.Exec</tspan>  INSERT INTO bookings</text>

  <!-- Step 7: Commit -->
  <rect x="193" y="476" width="306" height="24" rx="3" fill="#ede9fe" stroke="#a78bfa" stroke-width="1"/>
  <rect x="193" y="476" width="24"  height="24" rx="3" fill="#7c3aed"/>
  <text x="205" y="493" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">7</text>
  <text x="346" y="493" text-anchor="middle" font-size="10" fill="#0f172a">tx<tspan font-weight="bold">.Commit()</tspan></text>

  <!-- Step 8: Unlock — shortened to fit -->
  <rect x="193" y="504" width="306" height="24" rx="3" fill="#fef3c7" stroke="#fbbf24" stroke-width="1"/>
  <rect x="193" y="504" width="24"  height="24" rx="3" fill="#f59e0b"/>
  <text x="205" y="521" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">8</text>
  <text x="346" y="521" text-anchor="middle" font-size="10" fill="#0f172a">bookingMutex<tspan font-weight="bold">.Unlock()</tspan>  →  next</text>

  <!-- ══ SERIALIZED EXECUTION TIMELINE ══ -->
  <!-- Divider placed below critical section box (bottom = 530) -->
  <line x1="30" y1="544" x2="790" y2="544" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="10 4"/>

  <rect x="30" y="552" width="760" height="80" rx="6" fill="#f0fdf4" stroke="#86efac" stroke-width="1.5"/>
  <rect x="30" y="552" width="196" height="18" rx="3" fill="#15803d"/>
  <text x="128" y="565" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">«invariant»  Serialized Execution</text>

  <!-- Timeline bar -->
  <rect x="50" y="578" width="720" height="14" rx="7" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1"/>
  <rect x="50"  y="578" width="132" height="14" rx="7" fill="#0284c7"/>
  <rect x="194" y="578" width="132" height="14" rx="3" fill="#16a34a"/>
  <rect x="338" y="578" width="132" height="14" rx="3" fill="#7c3aed"/>
  <rect x="482" y="578" width="132" height="14" rx="3" fill="#d97706"/>
  <rect x="626" y="578" width="132" height="14" rx="7" fill="#dc2626"/>

  <text x="116" y="589" text-anchor="middle" font-size="9" font-weight="bold" fill="#fff">Req 1</text>
  <text x="260" y="589" text-anchor="middle" font-size="9" font-weight="bold" fill="#fff">Req 2</text>
  <text x="404" y="589" text-anchor="middle" font-size="9" font-weight="bold" fill="#fff">Req 3</text>
  <text x="548" y="589" text-anchor="middle" font-size="9" font-weight="bold" fill="#fff">Req 4</text>
  <text x="692" y="589" text-anchor="middle" font-size="9" font-weight="bold" fill="#fff">Req 5</text>

  <!-- Chevron separators -->
  <text x="183" y="589" text-anchor="middle" font-size="11" fill="#334155">›</text>
  <text x="327" y="589" text-anchor="middle" font-size="11" fill="#334155">›</text>
  <text x="471" y="589" text-anchor="middle" font-size="11" fill="#334155">›</text>
  <text x="615" y="589" text-anchor="middle" font-size="11" fill="#334155">›</text>

  <!-- Time axis -->
  <line x1="50" y1="598" x2="770" y2="598" stroke="#64748b" stroke-width="1.2" marker-end="url(#arr)"/>
  <text x="50"  y="612" font-size="9" fill="#64748b">t=0</text>
  <text x="756" y="612" font-size="9" fill="#64748b">t→</text>

  <!-- Invariant note — split into two lines to stay within bounds -->
  <text x="410" y="630" text-anchor="middle" font-size="10" font-weight="bold" fill="#15803d">No Parallel Execution  =  No Race Conditions</text>
  <text x="410" y="645" text-anchor="middle" font-size="10" font-weight="bold" fill="#15803d">=  No Double-Booking</text>

</svg>
